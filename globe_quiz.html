<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Quiz - Ultimate Expedition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Earcut -->
    <script src="https://unpkg.com/earcut@2.2.4/dist/earcut.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;800;900&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #0f172a;
            --panel-bg: rgba(15, 23, 42, 0.85);
            --accent-color: #38bdf8;
            --text-color: #f1f5f9;
            --border-color: rgba(56, 189, 248, 0.3);
            --panel-border-width: 1px;
            --font-main: 'Outfit', sans-serif;
            --font-head: 'Rubik', sans-serif;
            --sidebar-font-size: 0.875rem;
            --flag-size: 1.5rem;
        }

        body.theme-royal { --bg-color: #1a0b2e; --panel-bg: rgba(26, 11, 46, 0.85); --accent-color: #fbbf24; --text-color: #fef3c7; --border-color: rgba(251, 191, 36, 0.4); }
        body.theme-hologram { --bg-color: #000000; --panel-bg: rgba(0, 20, 0, 0.8); --accent-color: #00ff41; --text-color: #ccffcc; --border-color: rgba(0, 255, 65, 0.4); }
        body.theme-antique { --bg-color: #2c241b; --panel-bg: rgba(62, 50, 38, 0.9); --accent-color: #d4a373; --text-color: #faedcd; --border-color: rgba(212, 163, 115, 0.4); }
        body.theme-natgeo { --bg-color: #111111; --panel-bg: rgba(30, 30, 30, 0.9); --accent-color: #ffcc00; --text-color: #ffffff; --border-color: rgba(255, 204, 0, 0.6); }
        body.theme-navy { --bg-color: #0a192f; --panel-bg: rgba(17, 34, 64, 0.9); --accent-color: #64ffda; --text-color: #e6f1ff; --border-color: rgba(100, 255, 218, 0.4); }

        body { 
            margin: 0; overflow: hidden; background-color: var(--bg-color); font-family: var(--font-main); color: var(--text-color); transition: background-color 0.5s; 
        }
        
        #canvas-container { width: 100vw; height: 100vh; display: block; position: absolute; top: 0; left: 0; z-index: 0; }
        
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--panel-border-width) solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .naked-btn {
            background: transparent; border: none; color: var(--accent-color);
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; cursor: pointer; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .naked-btn:hover { transform: scale(1.15); color: white; filter: drop-shadow(0 0 8px var(--accent-color)); }

        .naked-panel {
            background: transparent; border: none; box-shadow: none; backdrop-filter: none;
            text-shadow: 0 2px 8px rgba(0,0,0,0.9), 0 0 15px rgba(0,0,0,0.5);
        }

        h1, h2, h3, .font-head { font-family: var(--font-head); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); margin: 10px 0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        .side-panel { transform: translateX(-120%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .side-panel.open { transform: translateX(0); }
        .settings-panel { transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .settings-panel.open { transform: translateX(0); }

        .subregion-header {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent-color);
            padding: 1.5rem 0.5rem 0.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem;
            position: sticky; top: 0; background: var(--panel-bg); z-index: 10; font-weight: 800;
        }

        .country-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-bottom: 1rem; }

        .country-item {
            padding: 0.4rem 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 0.75rem; border: 1px solid transparent; font-size: var(--sidebar-font-size);
            overflow: hidden; background: rgba(255,255,255,0.02);
        }
        .country-item:hover { background: rgba(255,255,255,0.1); border-color: var(--border-color); transform: translateY(-2px); }
        .country-item.found-correct { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #86efac; }
        .country-item.found-skipped { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #fca5a5; }
        .country-item img { width: var(--flag-size); height: auto; flex-shrink: 0; border-radius: 2px; }
        .country-item span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        input[type="text"], input[type="number"] {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--text-color); outline: none;
            padding: 0.75rem 1rem; border-radius: 0.75rem; transition: 0.3s; font-family: var(--font-main);
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--accent-color); box-shadow: 0 0 20px -5px var(--accent-color); background: rgba(0,0,0,0.6);
        }
        
        input[type=range] { accent-color: var(--accent-color); }
        input[type="color"] { 
            -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 50%; overflow: hidden; cursor: pointer; padding: 0; background: none; 
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid var(--border-color); border-radius: 50%; }

        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #0f172a; z-index: 1000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.8s ease-in-out;
        }
        .splash-loader {
            width: 240px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 2rem; overflow: hidden;
        }
        .splash-bar {
            width: 0%; height: 100%; background: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); transition: width 0.1s linear;
        }

        .loading-spinner {
            border: 3px solid var(--border-color); border-left-color: var(--accent-color); border-radius: 50%;
            width: 32px; height: 32px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Dropdown */
        .custom-select-btn {
            width: 100%; padding: 0.75rem 1rem; border-radius: 0.75rem;
            background: rgba(0,0,0,0.3); border: 1px solid var(--border-color);
            color: var(--text-color); text-align: left; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s;
        }
        .custom-select-btn:hover { border-color: var(--accent-color); background: rgba(0,0,0,0.5); }
        .custom-options {
            position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px;
            overflow-y: auto; background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 0.75rem; margin-top: 0.5rem; z-index: 60; display: none;
            backdrop-filter: blur(20px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .custom-options.show { display: block; }
        .option-item {
            padding: 0.5rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
            transition: background 0.2s; font-size: 0.9rem;
        }
        .option-item:hover { background: rgba(255,255,255,0.1); }
        .option-item img { width: 1.25rem; height: auto; border-radius: 2px; }

        .theme-list-btn {
            display: block; width: 100%; text-align: left; padding: 8px 12px; margin-bottom: 4px;
            font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            border: 1px solid var(--border-color); border-radius: 8px; opacity: 0.6; transition: 0.2s;
            background: rgba(255,255,255,0.02);
        }
        .theme-list-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); border-color: var(--accent-color); }
        
        .size-btn {
            font-size: 10px; font-weight: bold; padding: 6px; border-radius: 4px;
            border: 1px solid var(--border-color); opacity: 0.5; transition: 0.2s; background: rgba(255,255,255,0.05);
            flex: 1; text-align: center;
        }
        .size-btn:hover { opacity: 0.8; }
        .size-btn.active { opacity: 1; background: var(--accent-color); color: black; border-color: var(--accent-color); }

        .nav-preset { transition: all 0.2s; border: 1px solid transparent; }
        .nav-preset.active { background: var(--accent-color); color: black; border-color: white; }
        
        .mcq-btn {
            background: rgba(0,0,0,0.6); border: 1px solid var(--border-color); color: var(--text-color); backdrop-filter: blur(4px);
        }
        .mcq-btn:hover { background: var(--accent-color); color: #000; }

        .mcq-flag-only {
            background: transparent !important; border: none !important; backdrop-filter: none !important; padding: 0 !important;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .mcq-flag-only:hover { transform: scale(1.15); filter: drop-shadow(0 0 10px var(--accent-color)); }
        .mcq-flag-only img { height: 100px !important; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }

        /* --- RADIAL QUIZ MENU --- */
        .radial-menu-container {
            position: relative; width: 600px; height: 600px; display: flex; align-items: center; justify-content: center;
        }
        .radial-item {
            position: absolute; width: 140px; height: 140px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--item-color); color: #1e293b;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer; transform: scale(0); opacity: 0;
            z-index: 10; text-align: center;
        }
        .radial-item:hover { transform: scale(1.15) !important; z-index: 20; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .radial-center-btn {
            width: 100px; height: 100px; border-radius: 50%;
            background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s; z-index: 30;
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }
        .radial-center-btn:hover { transform: scale(1.1); background: white; }

        .quiz-drawer {
            position: absolute; top: 90%; left: 50%; transform: translateX(-50%);
            width: 200px; background: rgba(15,23,42,0.95); padding: 1rem; border-radius: 1rem;
            color: white; font-size: 0.75rem; pointer-events: none; opacity: 0;
            transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); margin-top: 10px;
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .radial-item:hover .quiz-drawer { opacity: 1; pointer-events: auto; }

        .toggle-btn {
            width: 40px; height: 20px; background: rgba(255,255,255,0.1); border-radius: 20px;
            position: relative; cursor: pointer; transition: 0.3s; border: 1px solid var(--border-color);
        }
        .toggle-btn.active { background: var(--accent-color); }
        .toggle-btn::after {
            content: ''; position: absolute; left: 2px; top: 2px; width: 14px; height: 14px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-btn.active::after { left: 22px; }

        .hud-control-btn {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .hud-control-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        
        .diff-easy-active { background: #22c55e !important; color: white; }
        .diff-med-active { background: #f97316 !important; color: white; }
        .diff-hard-active { background: #ef4444 !important; color: white; }
        .timer-active { border-color: var(--accent-color); color: var(--accent-color); }

        /* Country Name Label */
        #country-name-label {
            position: absolute; bottom: 8rem; left: 50%; transform: translateX(-50%);
            text-align: center; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 25; text-shadow: 0 4px 10px rgba(0,0,0,0.8);
        }
        #country-name-label.visible { opacity: 1; }
        #country-name-text {
            font-size: 3rem; font-weight: 900; font-family: 'Rubik', sans-serif;
            text-transform: uppercase; letter-spacing: 0.05em; color: white;
            -webkit-text-stroke: 1px rgba(0,0,0,0.5);
        }

        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="theme-cyber">

    <div id="canvas-container"></div>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <h1 class="text-6xl font-black font-head tracking-tighter text-white mb-2">GEOGRAPHY <span style="color: var(--accent-color)">QUIZ</span></h1>
        <p class="text-white/50 text-sm font-bold uppercase tracking-[0.3em]">Ultimate Expedition</p>
        <div class="splash-loader">
            <div class="splash-bar" id="splash-bar"></div>
        </div>
        <p class="text-xs mt-4 text-white/30 animate-pulse">Initializing Global Assets...</p>
    </div>

    <!-- Country Name Label -->
    <div id="country-name-label">
        <h1 id="country-name-text"></h1>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="absolute inset-0 z-50 flex items-center justify-center transition-opacity duration-500 opacity-0 pointer-events-none">
        <div class="glass-panel p-10 rounded-[2rem] max-w-sm w-full text-center relative flex flex-col gap-6 shadow-2xl border-t border-white/20">
            <div class="space-y-1">
                <div class="inline-block p-3 rounded-full bg-white/5 mb-2 border border-white/10">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--accent-color)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h1 class="text-3xl font-black font-head tracking-tight text-white">GEOGRAPHY QUIZ</h1>
                <p class="text-white/50 text-xs font-bold uppercase tracking-[0.2em]">Expedition Login</p>
            </div>
            
            <div id="login-form" class="flex flex-col gap-4 w-full text-left">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase opacity-60 ml-1">Identity</label>
                    <input type="text" id="user-name" placeholder="Name" class="w-full font-bold">
                </div>
                
                <div class="space-y-1 relative">
                    <label class="text-[10px] font-bold uppercase opacity-60 ml-1">Origin</label>
                    <button id="country-select-btn" class="custom-select-btn font-bold group">
                        <span class="flex items-center gap-2" id="selected-country-display">
                            <span class="opacity-50">Select Country</span>
                        </span>
                        <svg class="w-4 h-4 opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="country-dropdown-list" class="custom-options"></div>
                    <input type="hidden" id="user-country-val">
                </div>
            </div>

            <div class="space-y-3 w-full pt-2">
                <button id="login-btn" class="hidden w-full bg-white text-black font-black py-4 rounded-xl text-lg hover:scale-[1.02] active:scale-95 transition-all shadow-xl" style="background-color: var(--accent-color)">Play</button>
                <button id="guest-btn" class="hidden text-xs uppercase font-bold tracking-widest opacity-50 hover:opacity-100 transition-opacity">Continue as Guest</button>
            </div>
        </div>
    </div>

    <!-- Radial Quiz Menu -->
    <div id="quiz-menu" class="absolute inset-0 z-40 flex items-center justify-center hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm bg-black/60">
        <div class="radial-menu-container" id="radial-menu">
            <div class="radial-center-btn" onclick="closeQuizMenu()">
                <svg class="w-8 h-8 text-slate-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </div>
            <!-- Radial items populated by JS -->
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="absolute inset-0 z-50 flex items-center justify-center bg-red-900/40 backdrop-blur-md hidden">
        <div class="glass-panel p-8 rounded-[2rem] max-w-md w-full text-center border-red-500/50 shadow-red-500/20 shadow-2xl">
            <h1 class="text-5xl font-black mb-2 text-white">MISSION FAILED</h1>
            <p class="text-red-300 mb-8 font-bold tracking-widest uppercase">Signal Lost</p>
            <div class="flex flex-col gap-3">
                <button onclick="restartGame()" class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors">RETRY MISSION</button>
                <button onclick="openQuizMenu()" class="w-full bg-black/40 text-white border border-white/20 font-bold py-3 rounded-xl hover:bg-white/10 transition-colors">CHANGE MISSION</button>
                <button onclick="exitToNav()" class="w-full text-xs uppercase font-bold tracking-widest opacity-60 hover:opacity-100 py-2">Return to Navigation</button>
            </div>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="absolute top-4 left-0 w-full flex justify-between px-8 pointer-events-none z-30 opacity-0 transition-opacity duration-500" id="top-ui">
        <div class="flex gap-4 pointer-events-auto">
            <button id="toggle-left" class="naked-btn" title="Country Index">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
            <button id="reset-cam" class="naked-btn" title="Reset View" onclick="resetView()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            </button>
            <button id="reset-globe" class="naked-btn" title="Reset Globe State" onclick="resetGlobeState()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>

        <div id="hud-bar" class="glass-panel px-8 py-3 rounded-full flex items-center gap-8 pointer-events-auto">
            <button onclick="openQuizMenu()" class="text-white hover:text-white/80 text-sm font-black uppercase tracking-widest transition-all hover:scale-105" style="text-shadow: 0 0 10px rgba(255,255,255,0.3)">
                <span id="quiz-btn-text">QUIZ MENU</span>
            </button>
            <div class="w-px h-8 bg-white/20"></div>
            <div class="flex items-center gap-6">
                <div id="global-diff-btn" class="hud-control-btn diff-med-active" title="Difficulty: Medium" onclick="toggleGlobalDifficulty()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div id="global-timer-btn" class="hud-control-btn relative" title="Timer: Off" onclick="toggleGlobalTimer()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="timer-badge" class="absolute -top-1 -right-1 text-[8px] bg-white text-black font-bold px-1 rounded-full hidden">0</span>
                </div>

                <div class="text-right">
                    <div class="text-[10px] opacity-60 uppercase font-bold">Score</div>
                    <div id="score-display" class="font-mono text-2xl font-black leading-none text-white">0</div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[10px] opacity-60 uppercase font-bold text-red-400">Errors</div>
                    <div class="font-mono text-2xl font-black leading-none text-red-400" id="lives-display">0/3</div>
                </div>
            </div>
            
            <div class="hidden md:block w-px h-8 bg-white/20"></div>
            <div id="active-mode-display" class="hidden md:block text-xs font-bold uppercase tracking-wider opacity-80" style="color: var(--accent-color)">NAVIGATION MODE</div>
            
            <div id="timer-ui" class="hidden flex items-center gap-2 text-white border-l border-white/20 pl-6">
                <span id="countdown-display" class="font-mono text-2xl font-bold animate-pulse text-red-400">--</span>
            </div>
        </div>

        <button id="toggle-right" class="naked-btn pointer-events-auto" title="Settings">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
    </div>

    <!-- Left Sidebar -->
    <div id="left-panel" class="absolute top-0 left-0 h-full w-auto min-w-[20rem] max-w-[35vw] side-panel z-20 pt-24 pb-8 pl-6 pointer-events-none">
        <div class="glass-panel w-full h-full rounded-[2rem] overflow-hidden flex flex-col pointer-events-auto shadow-2xl">
            <div class="p-5 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-sm font-bold opacity-70 uppercase tracking-widest">Country Index</h2>
            </div>
            <div class="px-5 py-3 border-b border-white/10">
                <label class="text-[10px] uppercase font-bold opacity-60 mb-2 block">Flag Size</label>
                <div class="flex gap-1" id="size-controls">
                    <button class="size-btn" onclick="setFlagSize('S', this)">S</button>
                    <button class="size-btn active" onclick="setFlagSize('M', this)">M</button>
                    <button class="size-btn" onclick="setFlagSize('L', this)">L</button>
                    <button class="size-btn" onclick="setFlagSize('XL', this)">XL</button>
                </div>
            </div>
            <div id="country-list" class="flex-1 overflow-y-auto p-4 scroll-smooth"></div>
        </div>
    </div>

    <!-- Right Settings Panel -->
    <div id="right-panel" class="absolute top-0 right-0 h-full w-80 settings-panel z-20 pt-24 pb-8 pr-6 pointer-events-none">
        <div class="glass-panel w-full h-full rounded-[2rem] p-6 overflow-y-auto pointer-events-auto shadow-2xl">
            <h2 class="text-xl font-bold mb-6 opacity-90 border-b border-white/10 pb-2">SETTINGS</h2>
            <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                <button class="settings-tab-btn flex-1 py-1 text-xs font-bold uppercase tracking-wider opacity-50 hover:opacity-100 transition-all active-tab" data-tab="nav">Nav</button>
                <button class="settings-tab-btn flex-1 py-1 text-xs font-bold uppercase tracking-wider opacity-50 hover:opacity-100 transition-all" data-tab="style">Style</button>
            </div>
            <!-- Nav -->
            <div id="tab-nav" class="space-y-6">
                <div>
                    <label class="text-xs font-bold opacity-60 uppercase mb-2 block">Sensitivity Preset</label>
                    <div class="flex gap-2">
                        <button class="nav-preset w-full py-2 bg-white/10 rounded text-xs font-bold hover:bg-white/20" data-val="low">Low</button>
                        <button class="nav-preset active w-full py-2 bg-white/10 rounded text-xs font-bold hover:bg-white/20" data-val="med">Med</button>
                        <button class="nav-preset w-full py-2 bg-white/10 rounded text-xs font-bold hover:bg-white/20" data-val="high">High</button>
                    </div>
                </div>
                <details class="group">
                    <summary class="flex justify-between items-center font-bold cursor-pointer list-none text-xs uppercase opacity-70 hover:opacity-100 mt-4 rounded">
                        <span>ADVANCED</span>
                        <span class="transition group-open:rotate-180"><svg fill="none" height="16" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" width="16"><path d="M6 9l6 6 6-6"></path></svg></span>
                    </summary>
                    <div class="text-neutral-600 mt-4 group-open:animate-fadeIn space-y-4 pl-2 border-l border-white/10">
                        <div><label class="text-[10px] text-white/60 uppercase">Rotate Speed</label><input type="range" id="nav-speed" min="0.1" max="2.0" step="0.1" class="w-full mt-1"></div>
                        <div><label class="text-[10px] text-white/60 uppercase">Zoom Speed</label><input type="range" id="nav-zoom" min="0.1" max="2.0" step="0.1" class="w-full mt-1"></div>
                        <div><label class="text-[10px] text-white/60 uppercase">Damping</label><input type="range" id="nav-damping" min="0.01" max="0.3" step="0.01" class="w-full mt-1"></div>
                        <div><label class="text-[10px] text-white/60 uppercase">Auto-Rotate</label><input type="range" id="nav-autorotate" min="0" max="5.0" step="0.5" class="w-full mt-1"></div>
                        <div><label class="text-[10px] text-white/60 uppercase">Min Dist</label><input type="range" id="nav-min" min="11" max="20" step="1" class="w-full mt-1"></div>
                        <div><label class="text-[10px] text-white/60 uppercase">Max Dist</label><input type="range" id="nav-max" min="20" max="100" step="5" class="w-full mt-1"></div>
                    </div>
                </details>
            </div>
            <!-- Style -->
            <div id="tab-style" class="space-y-5 hidden">
                 <div>
                    <label class="text-xs font-bold opacity-60 uppercase mb-2 block">UI Theme</label>
                    <div class="flex flex-col gap-1">
                        <button class="theme-list-btn" onclick="setTheme('cyber')">Cyber</button>
                        <button class="theme-list-btn" onclick="setTheme('royal')">Royal</button>
                        <button class="theme-list-btn" onclick="setTheme('hologram')">Hologram</button>
                        <button class="theme-list-btn" onclick="setTheme('antique')">Old Map</button>
                        <button class="theme-list-btn" onclick="setTheme('natgeo')">NatGeo</button>
                        <button class="theme-list-btn" onclick="setTheme('navy')">Navy</button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold opacity-60 uppercase">Lat/Long Grid</label>
                    <div id="toggle-graticule" class="toggle-btn active" onclick="toggleSwitch(this, 'graticule')"></div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold opacity-60 uppercase">Borders</label>
                    <div id="toggle-borders" class="toggle-btn active" onclick="toggleSwitch(this, 'borders')"></div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold opacity-60 uppercase">Border Color</label>
                    <input type="color" id="border-color-picker" value="#ffffff">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 uppercase">Border Line Width</label>
                    <input type="range" id="border-thickness" min="1" max="10" step="0.5" value="2" class="w-full mt-2 h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 uppercase">UI Panel Thickness</label>
                    <input type="range" id="ui-border-width" min="0" max="8" step="1" value="2" class="w-full mt-2 h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Game Panel -->
    <div class="absolute bottom-10 w-full flex justify-center pointer-events-none z-30">
        <div id="game-panel" class="naked-panel px-4 py-4 pointer-events-auto transform transition-all duration-500 translate-y-40 opacity-0 w-auto inline-flex flex-col items-center max-w-[95vw]">
            <div id="prompt-container" class="flex flex-col md:flex-row items-center gap-12 justify-center w-full">
                <div id="flag-display" class="hidden shrink-0 filter drop-shadow-2xl transition-all">
                    <img id="flag-img" src="" class="h-28 w-auto object-contain transform hover:scale-110 transition-transform">
                </div>
                <div class="text-center md:text-left whitespace-nowrap text-shadow-strong">
                    <h2 id="main-question" class="text-4xl md:text-6xl font-black text-white leading-none mb-2">Initializing...</h2>
                    <p id="sub-question" class="font-bold text-lg tracking-[0.2em] uppercase" style="color: var(--accent-color)">System Standby</p>
                </div>
            </div>
            <div id="input-area" class="w-full flex flex-col items-center gap-6 mt-8 transition-all">
                <form id="type-form" class="w-full hidden">
                    <input type="text" id="answer-input" placeholder="TYPE NAME" class="w-96 px-8 py-4 rounded-full text-center text-xl font-bold bg-black/40 border border-white/40 focus:w-[32rem] transition-all backdrop-blur-md text-shadow-strong">
                </form>
                <div id="mcq-grid" class="hidden grid grid-cols-2 gap-6 w-full max-w-2xl"></div>
                <div class="flex flex-col items-center gap-3">
                    <div id="feedback" class="h-8 text-xl font-bold text-center tracking-widest uppercase transition-all duration-300 text-shadow-strong"></div>
                </div>
            </div>
        </div>
    </div>

    <button id="skip-btn" class="absolute bottom-8 right-8 z-40 bg-white/10 hover:bg-white/20 text-white/80 border-2 border-white/20 px-6 py-3 rounded-full text-sm font-bold uppercase tracking-widest transition-all hidden backdrop-blur-md hover:scale-105 pointer-events-auto">Skip Mission â†’</button>

    <script>
        const CONFIG = {
            // Using 2K for stability per user request, can be swapped to 4096 if needed.
            textureUrl: 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg',
            geoJsonUrl: 'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_50m_admin_0_countries.geojson',
            highlightColor: 0x38bdf8
        };

        const SVGS = {
            target: `<svg class="quiz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>`,
            question: `<svg class="quiz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            flag: `<svg class="quiz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-8a2 2 0 012-2h14a2 2 0 012 2v8M3 13V6a2 2 0 012-2h14a2 2 0 012 2v7m-10-3h4"></path></svg>`,
            reverse: `<svg class="quiz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>`,
            master: `<svg class="quiz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
            global: `<svg class="quiz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        };

        const MODES = {
            1: { name: "Locate", desc: "Find the requested country.", icon: SVGS.target, color: "#38bdf8" },
            2: { name: "Identify", desc: "Name the highlighted country.", icon: SVGS.question, color: "#a855f7" },
            3: { name: "Flag Match", desc: "Match flag to country.", icon: SVGS.flag, color: "#f472b6" },
            4: { name: "Rev. Locate", desc: "Find country by flag.", icon: SVGS.reverse, color: "#fb923c" },
            5: { name: "Master", desc: "Type name of country.", icon: SVGS.master, color: "#34d399" }, 
            6: { name: "Marathon", desc: "Find all countries.", icon: SVGS.global, color: "#ef4444" }
        };

        const STATE = {
            loggedIn: false, userName: "Guest", userCountry: "Unknown", mode: 0,
            countries: [], targetIndex: -1, score: 0, falseGuesses: 0, maxLives: 3, 
            globalDifficulty: 'medium', globalTimeLimit: 0,
            found: new Set(), results: {}, startTime: 0,
            mapWidth: 4096, mapHeight: 2048, mapData: null,
            statusData: new Uint8Array(256), statusTexture: null,
            flagCanvas: null, flagCtx: null, flagTexture: null,
            sidebarLocked: false, currentTheme: 'cyber', isFlying: false,
            questionStartTime: 0, timerInterval: null
        };

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sunLight = new THREE.DirectionalLight(0xffffff, 0.8); sunLight.position.set(50, 30, 50); scene.add(sunLight);
        const backLight = new THREE.DirectionalLight(0x445588, 0.4); backLight.position.set(-50, -10, -50); scene.add(backLight);

        const starsGeo = new THREE.BufferGeometry();
        const posArray = new Float32Array(2000 * 3);
        for(let i=0; i<6000; i++) posArray[i] = (Math.random() - 0.5) * 500;
        starsGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({size: 0.5, color: 0xffffff, transparent: true, opacity: 0.8})));

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 25; camera.position.y = 10;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.minDistance = 12; controls.maxDistance = 60;
        controls.autoRotate = true; controls.autoRotateSpeed = 0.5;
        controls.addEventListener('start', () => { STATE.isFlying = false; }); 

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // Globe Group
        const globeGroup = new THREE.Group(); scene.add(globeGroup);
        const earthMat = new THREE.MeshPhongMaterial({ color: 0xffffff, shininess: 25, specular: 0x222222, emissive: 0x001133, emissiveIntensity: 0.3 });
        
        // Loader Manager for Splash Screen
        const manager = new THREE.LoadingManager();
        const textureLoader = new THREE.TextureLoader(manager);
        
        // Stable 2K Texture
        textureLoader.load(CONFIG.textureUrl, (t) => { 
            earthMat.map = t; 
            earthMat.needsUpdate = true; 
        });
        
        const earthMesh = new THREE.Mesh(new THREE.SphereGeometry(10, 128, 128), earthMat);
        earthMesh.name = "Earth";
        globeGroup.add(earthMesh);

        // Highlight & Flag Fill Shader
        STATE.flagCanvas = document.createElement('canvas');
        STATE.flagCanvas.width = 1024; STATE.flagCanvas.height = 512; 
        STATE.flagCtx = STATE.flagCanvas.getContext('2d');
        STATE.flagTexture = new THREE.CanvasTexture(STATE.flagCanvas);
        STATE.flagTexture.minFilter = THREE.LinearFilter; 

        let highlightMaterial;
        function createHighlightSphere() {
            STATE.statusTexture = new THREE.DataTexture(STATE.statusData, 256, 1, THREE.RedFormat, THREE.UnsignedByteType);
            STATE.statusTexture.minFilter = THREE.NearestFilter; STATE.statusTexture.magFilter = THREE.NearestFilter; STATE.statusTexture.needsUpdate = true;

            highlightMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    tLookup: { value: null }, tStatus: { value: STATE.statusTexture },
                    tFlag: { value: STATE.flagTexture }, 
                    uFlagBounds: { value: new THREE.Vector4(0,0,1,1) },
                    uTargetId: { value: -1.0 }, uColor: { value: new THREE.Color(0x38bdf8) },
                    uTime: { value: 0 }, uFail: { value: 0.0 }, uShowFlag: { value: 0.0 },
                    uAspect: { value: 1.0 }
                },
                vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                fragmentShader: `
                    uniform sampler2D tLookup; uniform sampler2D tStatus; uniform sampler2D tFlag;
                    uniform vec4 uFlagBounds; uniform float uTargetId; uniform vec3 uColor; 
                    uniform float uTime; uniform float uFail; uniform float uShowFlag;
                    uniform float uAspect;
                    varying vec2 vUv;
                    
                    void main() {
                        vec4 texData = texture2D(tLookup, vUv);
                        float id = floor(texData.r * 255.0 + 0.5);
                        float isMain = texData.g; // G channel for colony filtering
                        
                        if (id < 0.5) discard; 
                        
                        float lookupU = (id + 0.5) / 256.0;
                        float status = texture2D(tStatus, vec2(lookupU, 0.5)).r;
                        bool isActive = (abs(id - uTargetId) < 0.5 && uTargetId > -0.5);

                        // Uniform "Cover" Scaling for Flag (UV Based)
                        if (isActive && uShowFlag > 0.5 && isMain > 0.5) {
                            vec2 rawUV = (vUv - uFlagBounds.xy) / uFlagBounds.zw;
                            
                            if(rawUV.x >= 0.0 && rawUV.x <= 1.0 && rawUV.y >= 0.0 && rawUV.y <= 1.0) {
                                vec2 centered = rawUV - 0.5;
                                float flagAspect = 1.5; 
                                vec2 scale = vec2(1.0);
                                
                                // To "Cover" without distortion:
                                // If Country is wider (Aspect > 1.5), we need to zoom in Y (scale Y down relative to X)
                                // If Country is taller (Aspect < 1.5), we need to zoom in X (scale X down relative to Y)
                                
                                // Let's use simple max dimension fitting
                                if(uAspect > flagAspect) scale.y = uAspect / flagAspect;
                                else scale.x = flagAspect / uAspect;
                                
                                vec2 flagUV = centered * scale + 0.5;
                                
                                if(flagUV.x >= 0.0 && flagUV.x <= 1.0 && flagUV.y >= 0.0 && flagUV.y <= 1.0) {
                                    vec4 flagColor = texture2D(tFlag, flagUV);
                                    gl_FragColor = vec4(flagColor.rgb, 0.9);
                                    return;
                                }
                            }
                        }

                        if (isActive) { gl_FragColor = vec4(uFail > 0.5 ? vec3(1.0, 0.0, 0.0) : uColor, 0.4); } 
                        else if (status > 0.9) { gl_FragColor = vec4(0.13, 0.77, 0.37, 0.4); } // Green
                        else if (status > 0.4 && status < 0.6) { gl_FragColor = vec4(0.93, 0.26, 0.26, 0.4); } // Red
                        else { discard; }
                    }
                `,
                transparent: true, side: THREE.FrontSide
            });
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(10.02, 128, 128), highlightMaterial);
            mesh.name = "Highlight";
            globeGroup.add(mesh);
        }
        createHighlightSphere();

        const atmoMat = new THREE.ShaderMaterial({
            uniforms: { color: { value: new THREE.Color(0x38bdf8) }, uFail: { value: 0.0 } },
            vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `uniform vec3 color; uniform float uFail; varying vec3 vNormal; void main() { float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 6.0); gl_FragColor = vec4(uFail > 0.5 ? vec3(1.0, 0.0, 0.0) : color, 1.0) * intensity * 0.8; }`,
            blending: THREE.AdditiveBlending, side: THREE.BackSide, transparent: true
        });
        globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(10.3, 64, 64), atmoMat));

        const graticuleGroup = new THREE.Group(); globeGroup.add(graticuleGroup);

        function setTheme(theme) {
            document.body.className = `theme-${theme}`;
            const accent = getComputedStyle(document.body).getPropertyValue('--accent-color').trim();
            const bg = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
            atmoMat.uniforms.color.value.set(accent);
            highlightMaterial.uniforms.uColor.value.set(accent); 
            scene.fog = new THREE.FogExp2(bg, 0.02);
        }

        // --- DATA ---
        let textureLoaded = false;
        manager.onLoad = () => { textureLoaded = true; checkLoadStatus(); };
        let geoDataLoaded = false;

        function checkLoadStatus() {
            if (textureLoaded && geoDataLoaded) {
                const bar = document.getElementById('splash-bar');
                if(bar) bar.style.width = "100%";
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    if (splash) splash.style.opacity = '0';
                    setTimeout(() => {
                        if (splash) splash.style.display = 'none';
                        const loginModal = document.getElementById('login-modal');
                        if (loginModal) loginModal.classList.remove('opacity-0', 'pointer-events-none');
                        const loginBtn = document.getElementById('login-btn');
                        if (loginBtn) loginBtn.classList.remove('hidden');
                        const guestBtn = document.getElementById('guest-btn');
                        if (guestBtn) guestBtn.classList.remove('hidden');
                        const loadingState = document.getElementById('loading-state');
                        if (loadingState) loadingState.classList.add('hidden');
                    }, 800);
                }, 800);
            }
        }

        async function loadData() {
            try {
                const res = await fetch(CONFIG.geoJsonUrl);
                const data = await res.json();
                
                data.features.forEach(f => {
                    if (f.properties.ISO_A2 === '-99') {
                        if (f.properties.NAME === 'France') f.properties.ISO_A2 = 'FR';
                        else if (f.properties.NAME === 'Norway') f.properties.ISO_A2 = 'NO';
                    }
                });

                STATE.countries = data.features.map((f, index) => {
                    let mainPolyCoords = f.geometry.coordinates;
                    let maxLen = 0;
                    if (f.geometry.type === 'MultiPolygon') {
                        f.geometry.coordinates.forEach(poly => {
                            let len = poly[0].length; 
                            if(len > maxLen) { maxLen = len; mainPolyCoords = poly; }
                        });
                    } else {
                        mainPolyCoords = f.geometry.coordinates;
                    }

                    const bounds = f.geometry.type === 'MultiPolygon' ? getPolyBounds(mainPolyCoords[0]) : calculateBounds(f.geometry);
                    const center = [(bounds.minY+bounds.maxY)/2, (bounds.minX+bounds.maxX)/2];
                    
                    return {
                        id: index + 1, name: f.properties.NAME, iso: f.properties.ISO_A2,
                        continent: f.properties.CONTINENT, subregion: f.properties.SUBREGION,
                        geometry: f.geometry, center: center,
                        mainPolyCoords: mainPolyCoords,
                        bounds: bounds
                    };
                }).filter(c => c.iso && c.iso !== '-99');
                STATE.countries.sort((a,b) => a.name.localeCompare(b.name));
                
                populateDropdown();
                await new Promise(r => setTimeout(r, 50)); 
                generateLookupTexture();
                populateSidebar();
                createGraticule();
                populateQuizMenu();

                geoDataLoaded = true;
                checkLoadStatus();

            } catch (e) { console.error(e); }
        }

        function populateDropdown() {
            const list = document.getElementById('country-dropdown-list');
            if(!list) return;
            list.innerHTML = '';
            STATE.countries.forEach(c => {
                const item = document.createElement('div');
                item.className = 'option-item';
                item.innerHTML = `<img src="https://flagcdn.com/w40/${c.iso.toLowerCase()}.png"><span>${c.name}</span>`;
                item.onclick = () => {
                    document.getElementById('user-country-val').value = c.name;
                    document.getElementById('selected-country-display').innerHTML = item.innerHTML;
                    list.classList.remove('show');
                };
                list.appendChild(item);
            });
        }

        const countrySelectBtn = document.getElementById('country-select-btn');
        if(countrySelectBtn) {
            countrySelectBtn.onclick = (e) => {
                e.stopPropagation(); 
                const list = document.getElementById('country-dropdown-list');
                if(list) list.classList.toggle('show');
            };
        }
        window.addEventListener('click', () => { 
            const list = document.getElementById('country-dropdown-list');
            if(list) list.classList.remove('show'); 
        });

        function getPolyBounds(coords) {
             let minX=180, maxX=-180, minY=90, maxY=-90;
             coords.forEach(c => { if(c[0]<minX)minX=c[0]; if(c[0]>maxX)maxX=c[0]; if(c[1]<minY)minY=c[1]; if(c[1]>maxY)maxY=c[1]; });
             return {minX, maxX, minY, maxY};
        }

        function calculateBounds(geometry) {
            let minX = 180, maxX = -180, minY = 90, maxY = -90;
            const process = (coords) => {
                coords.forEach(c => { if (Array.isArray(c[0])) process(c); else { if (c[0]<minX)minX=c[0]; if(c[0]>maxX)maxX=c[0]; if(c[1]<minY)minY=c[1]; if(c[1]>maxY)maxY=c[1]; }});
            };
            process(geometry.coordinates);
            return { minX, maxX, minY, maxY };
        }

        // --- GRAPHICS ---
        function generateLookupTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 4096; canvas.height = 2048;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            STATE.countries.forEach(c => {
                // R Channel = ID
                // G Channel = Main Land Mask (255 if main, 0 if colony)
                
                // 1. Fill all colonies with ID but G=0
                ctx.fillStyle = `rgb(${c.id}, 0, 0)`; 
                drawGeometryToCanvas(ctx, c.geometry, canvas.width, canvas.height);

                // 2. Overwrite main land with G=255
                ctx.fillStyle = `rgb(${c.id}, 255, 0)`;
                let coords = c.geometry.type === 'MultiPolygon' ? c.mainPolyCoords : c.geometry.coordinates;
                const tempGeo = { type: "Polygon", coordinates: coords };
                drawGeometryToCanvas(ctx, tempGeo, canvas.width, canvas.height);
            });
            const tex = new THREE.CanvasTexture(canvas); tex.minFilter = THREE.NearestFilter; tex.magFilter = THREE.NearestFilter;
            highlightMaterial.uniforms.tLookup.value = tex;
            STATE.mapData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        }

        function drawGeometryToCanvas(ctx, geometry, w, h) {
            const drawPoly = (coords) => {
                ctx.beginPath();
                coords.forEach((pt, i) => {
                    const x = (pt[0] + 180) / 360 * w;
                    const y = (90 - pt[1]) / 180 * h;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                });
                ctx.fill();
            };
            if (geometry.type === 'Polygon') geometry.coordinates.forEach(drawPoly);
            else if (geometry.type === 'MultiPolygon') geometry.coordinates.forEach(poly => poly.forEach(drawPoly));
        }

        function createGraticule() {
            const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.1 });
            for(let i=0; i<24; i++) {
                const theta = (i/24) * Math.PI * 2, pts = [];
                for(let j=0; j<=64; j++) { const phi=(j/64)*Math.PI; pts.push(new THREE.Vector3(10.05*Math.sin(phi)*Math.cos(theta), 10.05*Math.cos(phi), 10.05*Math.sin(phi)*Math.sin(theta))); }
                graticuleGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), lineMat));
            }
            for(let i=1; i<18; i++) {
                const phi = (i * 10 * Math.PI/180), r = 10.05 * Math.sin(phi), y = 10.05 * Math.cos(phi), pts = [];
                for(let j=0; j<=64; j++) { const theta=(j/64)*Math.PI*2; pts.push(new THREE.Vector3(r*Math.cos(theta), y, r*Math.sin(theta))); }
                graticuleGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), lineMat));
            }
        }

        // --- INTERACTION ---
        function getCountryIdFromUV(uv) {
            if (!STATE.mapData) return 0;
            const x = Math.floor(uv.x * 4096), y = Math.floor((1 - uv.y) * 2048), idx = (y * 4096 + x) * 4;
            return STATE.mapData[idx];
        }

        let dragStartX = 0, dragStartY = 0;
        window.addEventListener('pointerdown', (e) => {
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            if(STATE.loggedIn) controls.autoRotate = false;
        });

        function handleInteraction(e, isClick) {
            if (e.target.closest('#login-modal, #left-panel, #right-panel, #quiz-menu, #game-panel, #hud-bar, #splash-screen, .naked-btn, #country-name-label')) return;
            if (!STATE.loggedIn) return;

            if (isClick) {
                const dist = Math.hypot(e.clientX - dragStartX, e.clientY - dragStartY);
                if (dist > 5) return; 
            }

            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            raycaster.setFromCamera(mouse, camera);
            
            const earthMesh = globeGroup.children.find(c => c.name === "Earth");
            if (!earthMesh) return;
            const intersects = raycaster.intersectObject(earthMesh); 

            if (intersects.length > 0) {
                const id = getCountryIdFromUV(intersects[0].uv);
                if (id > 0) {
                    if (isClick) {
                        const countryObj = STATE.countries.find(c => c.id === id);
                        if (countryObj) {
                            if (STATE.mode === 0) {
                                flyTo(countryObj.center[0], countryObj.center[1], false);
                                highlightMaterial.uniforms.uTargetId.value = id;
                                showFlagOnGlobe(countryObj);
                            } else {
                                const isInteractive = (STATE.mode === 1 || (STATE.mode === 2 && STATE.globalDifficulty === 'hard') || STATE.mode === 4 || STATE.mode === 5 || STATE.mode === 6);
                                if (isInteractive) checkAnswer(countryObj.id);
                            }
                        }
                    } else {
                        document.body.style.cursor = 'pointer';
                        const isInteractive = (STATE.mode === 0 || STATE.mode === 1 || (STATE.mode === 2 && STATE.globalDifficulty === 'hard') || STATE.mode === 4 || STATE.mode === 5 || STATE.mode === 6);
                        
                        if(isInteractive) {
                            if(STATE.mode !== 0 || highlightMaterial.uniforms.uShowFlag.value === 0.0) {
                                 highlightMaterial.uniforms.uTargetId.value = id;
                                 if(STATE.mode !== 0) highlightMaterial.uniforms.uShowFlag.value = 0.0;
                            }
                        }
                    }
                } else {
                    document.body.style.cursor = 'default';
                    if (!isClick && STATE.mode !== 0) highlightMaterial.uniforms.uTargetId.value = -1.0;
                }
            }
        }

        function showFlagOnGlobe(country) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = `https://flagcdn.com/w320/${country.iso.toLowerCase()}.png`;
            img.onload = () => {
                const ctx = STATE.flagCtx;
                ctx.fillStyle = "#000"; ctx.fillRect(0,0,1024,512);
                ctx.drawImage(img, 0, 0, 1024, 512);
                STATE.flagTexture.needsUpdate = true;
                
                if (STATE.mode === 0) {
                    const label = document.getElementById('country-name-label');
                    const text = document.getElementById('country-name-text');
                    if(label && text) {
                        text.textContent = country.name;
                        label.classList.add('visible');
                    }
                }

                const b = country.bounds;
                const minU = (b.minX + 180) / 360;
                const maxU = (b.maxX + 180) / 360;
                const minV = (90 - b.maxY) / 180;
                const maxV = (90 - b.minY) / 180;
                const realMinV = (b.minY + 90) / 180;
                const realMaxV = (b.maxY + 90) / 180;
                
                const aspect = (maxU - minU) / (realMaxV - realMinV) * 2.0; 
                highlightMaterial.uniforms.uAspect.value = aspect; 
                highlightMaterial.uniforms.uFlagBounds.value.set(minU, realMinV, maxU - minU, realMaxV - realMinV);
                highlightMaterial.uniforms.uShowFlag.value = 1.0;
                highlightMaterial.uniforms.uTargetId.value = country.id;
            };
        }

        function checkAnswer(id) {
            if (STATE.mode === 0) return;
            
            if (STATE.globalTimeLimit > 0 && STATE.questionStartTime > 0) {
                if (Date.now() - STATE.questionStartTime > STATE.globalTimeLimit * 1000) return;
            }

            if (STATE.mode === 6) {
                if(STATE.found.has(id)) { document.getElementById('feedback').textContent = "DUPLICATE"; return; }
                success(id); document.getElementById('answer-input').value = ''; return;
            }
            if (id === STATE.targetIndex) {
                success(id);
                if(STATE.mode === 2 && STATE.globalDifficulty === 'hard') {
                    const inputArea = document.getElementById('input-area');
                    inputArea.classList.remove('hidden');
                    document.getElementById('type-form').classList.remove('hidden');
                    document.getElementById('answer-input').focus();
                } 
                else if(STATE.mode === 4) {
                    document.getElementById('main-question').textContent = STATE.countries.find(x=>x.id===id).name;
                    setTimeout(nextRound, 1500);
                }
                else if (STATE.mode !== 2) { 
                    setTimeout(nextRound, 1500);
                }
            } else {
                failEffect();
            }
        }

        function failEffect() {
            highlightMaterial.uniforms.uFail.value = 1.0;
            atmoMat.uniforms.uFail.value = 1.0;
            setTimeout(() => { highlightMaterial.uniforms.uFail.value = 0.0; atmoMat.uniforms.uFail.value = 0.0; }, 500);
            document.getElementById('feedback').textContent = "NEGATIVE";
            STATE.score = Math.max(0, STATE.score - 50);
            STATE.falseGuesses++;
            updateHUD();
            if (STATE.falseGuesses >= STATE.maxLives) gameOver();
        }

        function success(id) {
            const c = STATE.countries.find(c => c.id === id);
            STATE.score += 100;
            STATE.statusData[id] = 255; STATE.statusTexture.needsUpdate = true;
            STATE.found.add(id);
            showFlagOnGlobe(c);
            updateHUD();
            if(STATE.mode === 6) flyTo(c.center[0], c.center[1], true);
            else if(STATE.globalDifficulty !== 'hard' || STATE.mode === 1) flyTo(c.center[0], c.center[1], false);
            const item = document.getElementById(`country-${id}`);
            if(item) { item.classList.add('found-correct'); item.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        function nextRound() {
            if (STATE.mode === 6 && STATE.found.size === STATE.countries.length) { alert("COMPLETE!"); return; }
            let available = STATE.countries.filter(c => !STATE.found.has(c.id));
            if (available.length === 0) { STATE.found.clear(); STATE.statusData.fill(0); STATE.statusTexture.needsUpdate = true; available = STATE.countries; }
            const target = available[Math.floor(Math.random() * available.length)];
            STATE.targetIndex = target.id;
            highlightMaterial.uniforms.uTargetId.value = -1.0; 
            setupUI(target);
            
            // Timer Reset
            if (STATE.globalTimeLimit > 0) {
                STATE.questionStartTime = Date.now();
                if(STATE.timerInterval) clearInterval(STATE.timerInterval);
                STATE.timerInterval = setInterval(() => {
                    const elapsed = (Date.now() - STATE.questionStartTime) / 1000;
                    const remaining = Math.ceil(STATE.globalTimeLimit - elapsed);
                    const timerEl = document.getElementById('countdown-display');
                    if(timerEl) timerEl.textContent = remaining > 0 ? remaining : "!";
                    if (remaining <= 0) {
                        clearInterval(STATE.timerInterval);
                        failEffect();
                        document.getElementById('feedback').textContent = "TIME OUT";
                        if (STATE.falseGuesses < STATE.maxLives) setTimeout(nextRound, 1500);
                    }
                }, 100);
            } else {
                if(STATE.timerInterval) clearInterval(STATE.timerInterval);
            }
        }

        function setupUI(target) {
            const flagUrl = `https://flagcdn.com/w160/${target.iso.toLowerCase()}.png`;
            const els = { flag: document.getElementById('flag-display'), img: document.getElementById('flag-img'), main: document.getElementById('main-question'), sub: document.getElementById('sub-question'), type: document.getElementById('type-form'), mcq: document.getElementById('mcq-grid'), feedback: document.getElementById('feedback'), input: document.getElementById('answer-input'), skip: document.getElementById('skip-btn') };
            els.flag.classList.add('hidden'); els.type.classList.add('hidden'); els.mcq.classList.add('hidden'); els.mcq.innerHTML = ''; els.feedback.textContent = ''; els.input.value = ''; els.skip.classList.remove('hidden');
            const diff = STATE.globalDifficulty;
            if (STATE.mode !== 1 && STATE.mode !== 3) els.type.classList.remove('hidden');
            
            if (STATE.mode === 1) { // Locate
                 els.flag.classList.remove('hidden'); els.img.src = flagUrl; els.main.textContent = target.name; els.sub.textContent = "LOCATE SECTOR"; 
                 if(diff === 'easy') flyTo(target.center[0], target.center[1], false); 
            }
            else if (STATE.mode === 2) { // Identify
                els.main.textContent = "IDENTIFY NATION";
                if(diff === 'easy') { 
                    els.flag.classList.remove('hidden'); els.img.src = flagUrl; 
                    flyTo(target.center[0], target.center[1], false); 
                    generateMCQ(target, 'name'); 
                } 
                else if(diff === 'medium') { 
                    flyTo(target.center[0], target.center[1], false); 
                    els.type.classList.remove('hidden'); // Text Input
                } 
                else if(diff === 'hard') {
                    // Hard: Show Flag, User clicks Globe, Then types name
                    els.flag.classList.remove('hidden'); els.img.src = flagUrl;
                    els.type.classList.add('hidden'); // Hide input initially
                }
            }
            else if (STATE.mode === 3) { // Flag Match
                els.main.textContent = target.name; 
                if(diff === 'easy' || diff === 'medium') flyTo(target.center[0], target.center[1], false); 
                generateMCQ(target, 'flag'); 
            }
            else if (STATE.mode === 4) { // Rev Locate
                els.flag.classList.remove('hidden'); els.img.src = flagUrl; 
                els.main.textContent = diff === 'easy' ? target.name : "UNKNOWN ORIGIN"; 
                if (diff === 'easy') flyTo(target.center[0], target.center[1], false); 
            }
            else if (STATE.mode === 5) { // Master
                flyTo(target.center[0], target.center[1]); els.main.textContent = "CLASSIFIED"; els.input.focus(); 
            }
            else if (STATE.mode === 6) { // Marathon
                els.main.textContent = "GLOBAL SCAN"; els.input.focus(); els.skip.classList.add('hidden'); 
            }
        }

        function generateMCQ(target, type) {
            const grid = document.getElementById('mcq-grid'); grid.classList.remove('hidden');
            let opts = [target];
            while(opts.length < 4) { const r = STATE.countries[Math.floor(Math.random() * STATE.countries.length)]; if(!opts.includes(r)) opts.push(r); }
            opts.sort(() => Math.random() - 0.5);
            opts.forEach(opt => {
                const btn = document.createElement('button'); btn.className = "mcq-btn w-full py-4 rounded-xl font-bold text-sm transition-all";
                if(type === 'name') btn.textContent = opt.name;
                else { btn.classList.add('mcq-flag-only'); const img = document.createElement('img'); img.src = `https://flagcdn.com/w160/${opt.iso.toLowerCase()}.png`; img.className = "h-12 mx-auto pointer-events-none"; btn.appendChild(img); }
                btn.onclick = () => checkAnswer(opt.id); grid.appendChild(btn);
            });
        }

        function flyTo(lat, lon, bounce) {
            STATE.isFlying = true;
            const phi = (90 - lat) * (Math.PI / 180), theta = (lon + 180) * (Math.PI / 180);
            const targetPos = new THREE.Vector3(-(20 * Math.sin(phi) * Math.cos(theta)), 20 * Math.cos(phi), 20 * Math.sin(phi) * Math.sin(theta));
            const startPos = camera.position.clone();
            const startTime = Date.now();
            function anim() {
                if(!STATE.isFlying) return;
                const now = Date.now(), p = Math.min((now - startTime) / 1000, 1), ease = 1 - Math.pow(1 - p, 3);
                camera.position.lerpVectors(startPos, targetPos, ease); camera.lookAt(0,0,0);
                if(p < 1) requestAnimationFrame(anim);
                else { STATE.isFlying = false; if(bounce) { } }
            }
            anim();
        }

        function resetView() {
            STATE.isFlying = true;
            const targetPos = new THREE.Vector3(0, 10, 25);
            const startPos = camera.position.clone();
            const startTime = Date.now();
            
            controls.autoRotate = true;
            updateSlider('nav-autorotate', 0.5);

            function anim() {
                if(!STATE.isFlying) return;
                const p = Math.min((Date.now() - startTime) / 1000, 1);
                camera.position.lerpVectors(startPos, targetPos, 1 - Math.pow(1 - p, 3));
                camera.lookAt(0,0,0);
                if(p < 1) requestAnimationFrame(anim); else STATE.isFlying = false;
            }
            anim();
        }

        function resetGlobeState() {
            highlightMaterial.uniforms.uTargetId.value = -1.0;
            highlightMaterial.uniforms.uShowFlag.value = 0.0;
            highlightMaterial.uniforms.uFail.value = 0.0;
            STATE.found.clear();
            STATE.statusData.fill(0);
            STATE.statusTexture.needsUpdate = true;
            
            // Hide Label
            const label = document.getElementById('country-name-label');
            if(label) label.classList.remove('visible');

            document.querySelectorAll('.country-item').forEach(el => el.classList.remove('found-correct', 'found-skipped'));
            
            // Also reset view
            resetView();
        }

        // --- STATE/UI ---
        function setMode(modeId, difficulty, timeLimit) {
            STATE.mode = parseInt(modeId);
            if(difficulty) STATE.difficulty = difficulty;
            if(timeLimit !== undefined) STATE.timeLimit = timeLimit; else STATE.timeLimit = 0;
            
            STATE.score = 0; STATE.falseGuesses = 0; STATE.found.clear();
            STATE.statusData.fill(0); STATE.statusTexture.needsUpdate = true;
            highlightMaterial.uniforms.uShowFlag.value = 0.0;
            document.querySelectorAll('.country-item').forEach(el => el.classList.remove('found-correct', 'found-skipped'));
            
            // Hide Label on mode change
            const label = document.getElementById('country-name-label');
            if(label) label.classList.remove('visible');
            
            updateHUD();
            
            if (STATE.mode === 0) {
                document.getElementById('active-mode-display').textContent = "NAVIGATION MODE";
                document.getElementById('game-panel').classList.add('opacity-0', 'translate-y-40');
                document.getElementById('skip-btn').classList.add('hidden');
                document.getElementById('timer-ui').classList.add('hidden');
                document.getElementById('quiz-btn-text').textContent = "SELECT MISSION";
                highlightMaterial.uniforms.uTargetId.value = -1.0; 
            } else {
                document.getElementById('active-mode-display').textContent = MODES[STATE.mode].name;
                document.getElementById('game-panel').classList.remove('opacity-0', 'translate-y-40');
                document.getElementById('quiz-btn-text').textContent = "QUIZ MENU";
                if (STATE.globalTimeLimit > 0) {
                    document.getElementById('timer-ui').classList.remove('hidden');
                    document.getElementById('countdown-display').textContent = STATE.globalTimeLimit;
                } else {
                    document.getElementById('timer-ui').classList.add('hidden');
                }
                if(STATE.loggedIn) controls.autoRotate = false;
                nextRound();
            }
        }

        function updateHUD() {
            document.getElementById('score-display').textContent = STATE.score;
            document.getElementById('lives-display').textContent = `${STATE.falseGuesses}/${STATE.maxLives}`;
        }

        // FIX 3: Global Control Toggles
        window.toggleGlobalDifficulty = () => {
            const btn = document.getElementById('global-diff-btn');
            const current = STATE.globalDifficulty;
            let next = 'medium';
            if(current === 'medium') next = 'hard';
            else if(current === 'hard') next = 'easy';
            
            STATE.globalDifficulty = next;
            
            btn.className = `hud-control-btn diff-${next}-active`;
            btn.title = `Difficulty: ${next.charAt(0).toUpperCase() + next.slice(1)}`;
            
            // If quiz is active, re-render to apply new difficulty rules (like showing/hiding MCQ)
            if(STATE.mode !== 0) {
                // Find current target and re-setup
                const target = STATE.countries.find(c => c.id === STATE.targetIndex);
                if(target) setupUI(target);
            }
        };

        window.toggleGlobalTimer = () => {
            const btn = document.getElementById('global-timer-btn');
            const badge = document.getElementById('timer-badge');
            let t = STATE.globalTimeLimit;
            if(t === 0) t = 3; else if(t === 3) t = 5; else if(t === 5) t = 10; else t = 0;
            
            STATE.globalTimeLimit = t;
            badge.textContent = t;
            
            if(t > 0) {
                btn.classList.add('timer-active');
                badge.classList.remove('hidden');
                if(STATE.mode !== 0) document.getElementById('timer-ui').classList.remove('hidden');
            } else {
                btn.classList.remove('timer-active');
                badge.classList.add('hidden');
                document.getElementById('timer-ui').classList.add('hidden');
            }
            
            // Restart timer for current round if active
            if(STATE.mode !== 0) nextRound(); // This is abrupt but ensures timer sync. Better: just reset timer logic
        };

        function populateSidebar() {
            const list = document.getElementById('country-list'); list.innerHTML = '';
            const grouped = {};
            STATE.countries.forEach(c => {
                let region = "Others";
                const sub = (c.subregion + c.continent).toLowerCase();
                if(sub.includes("africa")) region="Africa"; else if(sub.includes("europe")) region="Europe"; else if(sub.includes("asia")) region="Asia"; else if(sub.includes("north") || sub.includes("caribbean") || sub.includes("central")) region="North America"; else if(sub.includes("south")) region="South America"; else if(sub.includes("oceania") || sub.includes("australia")) region="Oceania";
                if(!grouped[region]) grouped[region] = []; grouped[region].push(c);
            });
            ["Africa", "Asia", "Europe", "North America", "South America", "Oceania", "Others"].forEach(r => {
                if(!grouped[r]) return;
                const h = document.createElement('div'); h.className = 'subregion-header'; h.textContent = r; list.appendChild(h);
                const grid = document.createElement('div'); grid.className = 'country-grid'; list.appendChild(grid);
                grouped[r].forEach(c => {
                    const d = document.createElement('div'); d.id = `country-${c.id}`; d.className = 'country-item';
                    d.innerHTML = `<img src="https://flagcdn.com/w40/${c.iso.toLowerCase()}.png"><span>${c.name}</span>`;
                    d.onclick = () => { if (STATE.mode === 0) { flyTo(c.center[0], c.center[1], false); highlightMaterial.uniforms.uTargetId.value = c.id; showFlagOnGlobe(c); } };
                    grid.appendChild(d);
                });
            });
        }

        function populateQuizMenu() {
            const container = document.getElementById('radial-menu');
            const centerBtn = container.querySelector('.radial-center-btn');
            container.innerHTML = ''; container.appendChild(centerBtn);

            const keys = Object.keys(MODES);
            const radius = 220; 
            const angleStep = (2 * Math.PI) / keys.length;

            keys.forEach((key, index) => {
                const m = MODES[key];
                const angle = index * angleStep - Math.PI / 2; 
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const item = document.createElement('div');
                item.className = 'radial-item';
                item.style.setProperty('--item-color', m.color);
                item.style.left = `calc(50% + ${x}px - 70px)`; 
                item.style.top = `calc(50% + ${y}px - 70px)`;
                item.onclick = () => { closeQuizMenu(); setMode(key); };
                item.innerHTML = `
                    <div style="pointer-events: none;">
                        <div style="display:flex; justify-content:center;">${m.icon}</div>
                        <div class="font-black uppercase text-sm leading-tight mt-1">${m.name}</div>
                    </div>
                    <div class="quiz-drawer"><div>${m.desc}</div></div>
                `;
                container.appendChild(item);
            });
        }

        // --- LISTENERS ---
        document.getElementById('login-btn').onclick = () => {
            const nameInput = document.getElementById('user-name');
            if(!nameInput.value.trim()){ alert("Enter Name"); return; }
            STATE.userName = nameInput.value; startGame();
        };
        document.getElementById('guest-btn').onclick = () => { STATE.userName = "Guest"; startGame(); };
        
        function startGame() {
            STATE.loggedIn = true;
            document.getElementById('login-modal').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('top-ui').classList.remove('opacity-0');
            document.getElementById('left-panel').classList.remove('pointer-events-none');
            document.getElementById('right-panel').classList.remove('pointer-events-none');
            setMode(0);
        }

        document.getElementById('toggle-left').onclick = () => document.getElementById('left-panel').classList.toggle('open');
        document.getElementById('toggle-right').onclick = () => document.getElementById('right-panel').classList.toggle('open');

        document.querySelectorAll('.settings-tab-btn').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active-tab', 'opacity-100'));
                e.target.classList.add('active-tab', 'opacity-100');
                ['nav', 'style'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
                document.getElementById(`tab-${e.target.dataset.tab}`).classList.remove('hidden');
            };
        });

        function updateSlider(id, val) { const el = document.getElementById(id); if(el) { el.value = val; controls[id.replace('nav-', '').replace('speed', 'rotateSpeed').replace('min', 'minDistance').replace('max', 'maxDistance').replace('autorotate', 'autoRotateSpeed').replace('damping', 'dampingFactor')] = val; } }
        
        document.querySelectorAll('.nav-preset').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('.nav-preset').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                const val = e.target.dataset.val;
                if(val === 'low') { updateSlider('nav-speed', 0.2); updateSlider('nav-damping', 0.1); updateSlider('nav-zoom', 0.5); }
                if(val === 'med') { updateSlider('nav-speed', 0.5); updateSlider('nav-damping', 0.05); updateSlider('nav-zoom', 1.0); }
                if(val === 'high') { updateSlider('nav-speed', 1.0); updateSlider('nav-damping', 0.03); updateSlider('nav-zoom', 1.5); }
            };
        });

        const sliderMap = { 'nav-speed': 'rotateSpeed', 'nav-zoom': 'zoomSpeed', 'nav-damping': 'dampingFactor', 'nav-autorotate': 'autoRotateSpeed', 'nav-min': 'minDistance', 'nav-max': 'maxDistance' };
        Object.keys(sliderMap).forEach(id => document.getElementById(id).oninput = (e) => controls[sliderMap[id]] = parseFloat(e.target.value));

        function toggleSwitch(el, type) {
            el.classList.toggle('active'); const isActive = el.classList.contains('active');
            if(type === 'graticule') graticuleGroup.visible = isActive;
            if(type === 'borders') {
                // borderGroup.visible = isActive; // This line was problematic in previous version if borderGroup wasn't defined yet
                // Fixed in loadData call to drawVectorBorders
                // But let's check safety
                const bg = globeGroup.getObjectByName("Borders");
                if (bg) bg.visible = isActive;
            }
        }

        document.getElementById('border-color-picker').oninput = (e) => {
             const bg = globeGroup.getObjectByName("Borders");
             if(bg) bg.children.forEach(line => line.material.color.set(e.target.value));
        };
        document.getElementById('border-thickness').oninput = (e) => {
             // WebGL linewidth is limited to 1 on most systems, so this might not show visual change on Windows.
             const v = parseFloat(e.target.value);
             const bg = globeGroup.getObjectByName("Borders");
             if(bg) bg.children.forEach(line => line.material.linewidth = v);
        };
        document.getElementById('ui-border-width').oninput = (e) => document.documentElement.style.setProperty('--panel-border-width', e.target.value + 'px');

        function setFlagSize(size, btn) {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            const sizes = { 'S': '1rem', 'M': '1.5rem', 'L': '2.5rem', 'XL': '4rem' };
            const fonts = { 'S': '0.75rem', 'M': '0.9rem', 'L': '1rem', 'XL': '1.2rem' };
            document.documentElement.style.setProperty('--flag-size', sizes[size]);
            document.documentElement.style.setProperty('--sidebar-font-size', fonts[size]);
        }

        window.openQuizMenu = () => { 
            const menu = document.getElementById('quiz-menu');
            menu.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            document.getElementById('game-over-modal').classList.add('hidden');
            const items = menu.querySelectorAll('.radial-item');
            items.forEach((item, index) => { setTimeout(() => { item.style.transform = 'scale(1)'; item.style.opacity = '1'; }, index * 50); });
        };

        window.closeQuizMenu = () => { 
            const menu = document.getElementById('quiz-menu');
            const items = menu.querySelectorAll('.radial-item');
            items.forEach((item) => { item.style.transform = 'scale(0)'; item.style.opacity = '0'; });
            setTimeout(() => { menu.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => menu.classList.add('hidden'), 300); }, 300);
        };

        window.gameOver = () => { document.getElementById('game-over-modal').classList.remove('hidden'); document.getElementById('game-panel').classList.add('opacity-0', 'translate-y-40'); };
        window.restartGame = () => { document.getElementById('game-over-modal').classList.add('hidden'); setMode(STATE.mode); };
        window.exitToNav = () => { document.getElementById('game-over-modal').classList.add('hidden'); setMode(0); };
        
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
        window.addEventListener('mousemove', (e) => handleInteraction(e, false));
        window.addEventListener('click', (e) => handleInteraction(e, true));

        document.getElementById('skip-btn').onclick = () => {
            if(STATE.mode === 0) return;
            document.getElementById('feedback').textContent = "SKIPPED";
            STATE.statusData[STATE.targetIndex] = 128; STATE.statusTexture.needsUpdate = true; // Red
            const item = document.getElementById(`country-${STATE.targetIndex}`);
            if(item) { item.classList.add('found-skipped'); item.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            const c = STATE.countries.find(x => x.id === STATE.targetIndex);
            flyTo(c.center[0], c.center[1], false);
            updateHUD();
            setTimeout(nextRound, 2000);
        };

        function animate() { requestAnimationFrame(animate); controls.update(); if(highlightMaterial) highlightMaterial.uniforms.uTime.value += 0.02; renderer.render(scene, camera); }
        
        loadData();
        animate();
    </script>
</body>
</html>