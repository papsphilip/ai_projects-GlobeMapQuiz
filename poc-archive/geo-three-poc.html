<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Three Proof of Concept - Globe Quiz</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0f172a;
            color: white;
            font-family: system-ui, sans-serif;
            overflow: hidden;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        #info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            z-index: 100;
            font-size: 14px;
        }
        #info-panel h1 { font-size: 18px; margin-bottom: 10px; color: #38bdf8; }
        #info-panel p { margin: 8px 0; line-height: 1.5; }
        #info-panel .status { color: #22c55e; font-weight: bold; }
        #info-panel .error { color: #ef4444; font-weight: bold; }
        #info-panel .metric { color: #fbbf24; }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        button {
            background: #38bdf8;
            color: #0f172a;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #0ea5e9; }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 200;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #38bdf8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading geo-three...</div>
    </div>

    <div id="canvas-container"></div>

    <div id="info-panel">
        <h1>Geo-Three POC</h1>
        <p>Testing hybrid Three.js + tile streaming</p>
        <p>Status: <span id="status" class="status">Initializing...</span></p>
        <p>Provider: <span id="provider" class="metric">OpenStreetMap</span></p>
        <p>Zoom Level: <span id="zoom-level" class="metric">--</span></p>
        <p>FPS: <span id="fps" class="metric">--</span></p>
        <p>Tiles Loaded: <span id="tiles" class="metric">--</span></p>
        <hr style="margin: 15px 0; border-color: #333;">
        <p><strong>Controls:</strong></p>
        <p>- Drag to rotate</p>
        <p>- Scroll to zoom</p>
        <p>- Click buttons to fly to locations</p>
    </div>

    <div id="controls">
        <button onclick="flyTo(48.8566, 2.3522)">Paris</button>
        <button onclick="flyTo(35.6762, 139.6503)">Tokyo</button>
        <button onclick="flyTo(40.7128, -74.0060)">New York</button>
        <button onclick="flyTo(41.9028, 12.4964)">Vatican</button>
        <button onclick="flyTo(1.3521, 103.8198)">Singapore</button>
        <button onclick="resetView()">Reset</button>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- geo-three from jsDelivr CDN -->
    <script src="https://cdn.jsdelivr.net/npm/geo-three@0.1.15/build/geo-three.min.js"></script>

    <script>
        // ============================================
        // GEO-THREE PROOF OF CONCEPT
        // Purpose: Test tile streaming with Three.js globe
        // ============================================

        let scene, camera, renderer, controls, map;
        let frameCount = 0, lastTime = performance.now();

        // Status elements
        const statusEl = document.getElementById('status');
        const zoomEl = document.getElementById('zoom-level');
        const fpsEl = document.getElementById('fps');
        const tilesEl = document.getElementById('tiles');
        const loadingEl = document.getElementById('loading');

        // Check if geo-three loaded
        if (typeof Geo === 'undefined') {
            statusEl.textContent = 'ERROR: geo-three not loaded';
            statusEl.className = 'error';
            console.error('geo-three library not found. Check CDN URL.');
        } else {
            init();
        }

        function init() {
            try {
                // Scene setup
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0f172a);

                // Camera
                camera = new THREE.PerspectiveCamera(
                    60,
                    window.innerWidth / window.innerHeight,
                    0.01,
                    1000
                );
                camera.position.set(0, 0, 3);

                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.getElementById('canvas-container').appendChild(renderer.domElement);

                // Controls
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 1.1;
                controls.maxDistance = 10;
                controls.enablePan = false;

                // ============================================
                // GEO-THREE TILE MAP SETUP
                // ============================================

                // Create OpenStreetMap provider (no API key required)
                const provider = new Geo.OpenStreetMapsProvider();

                // Create spherical map view (globe mode)
                // Note: Geo.MapView.SPHERICAL for globe, PLANAR for flat map
                map = new Geo.MapView(Geo.MapView.SPHERICAL, provider);

                // Scale the globe (geo-three uses meters by default)
                // Scale to ~1 unit radius for Three.js compatibility
                map.scale.set(1/Geo.UnitsUtils.EARTH_RADIUS, 1/Geo.UnitsUtils.EARTH_RADIUS, 1/Geo.UnitsUtils.EARTH_RADIUS);

                scene.add(map);

                // Add ambient light
                const ambientLight = new THREE.AmbientLight(0xffffff, 1);
                scene.add(ambientLight);

                // Add directional light (sun-like)
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
                dirLight.position.set(5, 3, 5);
                scene.add(dirLight);

                // Hide loading screen
                loadingEl.style.display = 'none';
                statusEl.textContent = 'Ready - Globe with OSM tiles';

                // Start animation loop
                animate();

                // Window resize handler
                window.addEventListener('resize', onWindowResize);

                console.log('geo-three POC initialized successfully');
                console.log('Map object:', map);
                console.log('Provider:', provider);

            } catch (error) {
                console.error('Initialization error:', error);
                statusEl.textContent = 'ERROR: ' + error.message;
                statusEl.className = 'error';
                loadingEl.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            // Update controls
            controls.update();

            // Update geo-three LOD (if method exists)
            if (map && map.lod) {
                map.lod.update(map, camera, renderer, scene);
            }

            // Render
            renderer.render(scene, camera);

            // Update metrics
            updateMetrics();
        }

        function updateMetrics() {
            frameCount++;
            const now = performance.now();

            // Update FPS every second
            if (now - lastTime >= 1000) {
                fpsEl.textContent = frameCount;
                frameCount = 0;
                lastTime = now;

                // Estimate zoom level based on camera distance
                const distance = camera.position.length();
                const zoomEstimate = Math.max(0, Math.round(18 - Math.log2(distance)));
                zoomEl.textContent = zoomEstimate;

                // Count visible tiles (approximation)
                if (map) {
                    let tileCount = 0;
                    map.traverse((node) => {
                        if (node.isMesh) tileCount++;
                    });
                    tilesEl.textContent = tileCount;
                }
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Fly to a location (lat, lon in degrees)
        function flyTo(lat, lon) {
            // Convert lat/lon to spherical coordinates
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);

            // Calculate camera position at a close distance
            const distance = 1.5; // Close zoom
            const x = distance * Math.sin(phi) * Math.cos(theta);
            const y = distance * Math.cos(phi);
            const z = distance * Math.sin(phi) * Math.sin(theta);

            // Animate camera position
            const startPos = camera.position.clone();
            const endPos = new THREE.Vector3(x, y, z);
            const duration = 1500;
            const startTime = performance.now();

            function animateCamera() {
                const elapsed = performance.now() - startTime;
                const t = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - t, 3); // Ease out cubic

                camera.position.lerpVectors(startPos, endPos, eased);
                camera.lookAt(0, 0, 0);

                if (t < 1) {
                    requestAnimationFrame(animateCamera);
                }
            }

            animateCamera();
            statusEl.textContent = `Flying to ${lat.toFixed(2)}, ${lon.toFixed(2)}`;
        }

        function resetView() {
            camera.position.set(0, 0, 3);
            camera.lookAt(0, 0, 0);
            statusEl.textContent = 'View reset';
        }
    </script>
</body>
</html>
