<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three-Globe POC - High-Res Tile Streaming</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0f172a;
            color: white;
            font-family: system-ui, sans-serif;
            overflow: hidden;
        }
        #globe-container {
            width: 100vw;
            height: 100vh;
        }
        #info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border-radius: 12px;
            max-width: 380px;
            z-index: 100;
            font-size: 14px;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }
        #info-panel h1 { font-size: 18px; margin-bottom: 10px; color: #38bdf8; }
        #info-panel p { margin: 8px 0; line-height: 1.5; }
        .status { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warn { color: #fbbf24; }
        .metric { color: #fbbf24; }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 100;
            max-width: 600px;
        }
        button {
            background: #38bdf8;
            color: #0f172a;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.2s;
        }
        button:hover { background: #0ea5e9; transform: scale(1.05); }
        button.secondary { background: #6366f1; }
        button.secondary:hover { background: #4f46e5; }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #38bdf8;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #zoom-indicator {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
        }
        #console-output {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            z-index: 100;
            border: 1px solid #333;
        }
        #console-output .log { color: #888; }
        #console-output .success { color: #22c55e; }
        #console-output .error { color: #ef4444; }
        #console-output .warn { color: #fbbf24; }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Initializing...</div>
    </div>

    <div id="globe-container"></div>

    <div id="info-panel">
        <h1>Three-Globe POC v2</h1>
        <p>Testing: High-resolution tile streaming</p>
        <p>Status: <span id="status" class="status">Loading...</span></p>
        <p>Three.js: <span id="three-version" class="metric">--</span></p>
        <p>Three-Globe: <span id="globe-version" class="metric">--</span></p>
        <hr style="margin: 15px 0; border-color: #333;">
        <p><strong>Objective:</strong> Verify tile streaming works</p>
        <p>If tiles fail, will fall back to static texture</p>
    </div>

    <div id="zoom-indicator">
        Distance: <span id="camera-dist">--</span>
    </div>

    <div id="console-output">
        <strong>Debug Console:</strong><br>
    </div>

    <div id="controls">
        <button onclick="flyTo(48.8566, 2.3522, 150)">Paris</button>
        <button onclick="flyTo(35.6762, 139.6503, 150)">Tokyo</button>
        <button onclick="flyTo(41.9028, 12.4964, 105)">Vatican</button>
        <button onclick="flyTo(43.7384, 7.4246, 105)">Monaco</button>
        <button onclick="flyTo(1.3521, 103.8198, 110)">Singapore</button>
        <button class="secondary" onclick="resetView()">Reset</button>
    </div>

    <!-- Use THREE.js r128 like the main project (proven to work) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- OrbitControls from jsdelivr (proper MIME type) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Three-Globe - try multiple CDN sources -->
    <script>
        // Custom console to display on page
        const consoleEl = document.getElementById('console-output');
        function log(msg, type = 'log') {
            console.log(msg);
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `> ${msg}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
    </script>

    <!-- Try loading three-globe -->
    <script>
        log('Loading three-globe from CDN...');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three-globe@2.31.3/dist/three-globe.min.js"
            onerror="log('CDN 1 failed, trying alternate...', 'warn')"></script>

    <script>
        // ============================================
        // THREE-GLOBE POC v2
        // ============================================

        const statusEl = document.getElementById('status');
        const threeVerEl = document.getElementById('three-version');
        const globeVerEl = document.getElementById('globe-version');
        const distEl = document.getElementById('camera-dist');
        const loadingEl = document.getElementById('loading');

        let globe, renderer, scene, camera, controls;

        // Check dependencies
        log('Checking dependencies...');

        if (typeof THREE === 'undefined') {
            log('ERROR: Three.js not loaded!', 'error');
            statusEl.textContent = 'Three.js failed to load';
            statusEl.className = 'error';
        } else {
            log('Three.js loaded: r' + THREE.REVISION, 'success');
            threeVerEl.textContent = 'r' + THREE.REVISION;
        }

        if (typeof THREE.OrbitControls === 'undefined') {
            log('ERROR: OrbitControls not loaded!', 'error');
        } else {
            log('OrbitControls loaded', 'success');
        }

        if (typeof ThreeGlobe === 'undefined') {
            log('ERROR: ThreeGlobe not loaded!', 'error');
            statusEl.textContent = 'ThreeGlobe failed to load';
            statusEl.className = 'error';
            // Show what we can still do
            log('Will attempt fallback with basic sphere + texture', 'warn');
            initFallback();
        } else {
            log('ThreeGlobe loaded', 'success');
            globeVerEl.textContent = 'Loaded';

            // Check for tile engine method
            const testGlobe = new ThreeGlobe();
            if (typeof testGlobe.globeTileEngineUrl === 'function') {
                log('globeTileEngineUrl method EXISTS', 'success');
                initWithTiles();
            } else {
                log('globeTileEngineUrl NOT FOUND - using static texture', 'warn');
                log('Available methods: ' + Object.keys(testGlobe).filter(k => typeof testGlobe[k] === 'function').slice(0, 10).join(', '), 'log');
                initWithStaticTexture();
            }
        }

        function initWithTiles() {
            log('Initializing with tile streaming...');
            try {
                setupScene();

                globe = new ThreeGlobe()
                    .globeTileEngineUrl((x, y, l) =>
                        `https://tile.openstreetmap.org/${l}/${x}/${y}.png`
                    )
                    .globeTileEngineMaxZoom(19)
                    .showAtmosphere(true)
                    .atmosphereColor('#38bdf8')
                    .atmosphereAltitude(0.15);

                scene.add(globe);

                loadingEl.style.display = 'none';
                statusEl.textContent = 'Tile streaming active!';
                log('Globe with tiles created successfully!', 'success');

                animate();
            } catch (err) {
                log('Tile init error: ' + err.message, 'error');
                initWithStaticTexture();
            }
        }

        function initWithStaticTexture() {
            log('Initializing with static texture (fallback)...');
            try {
                setupScene();

                globe = new ThreeGlobe()
                    .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                    .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
                    .showAtmosphere(true)
                    .atmosphereColor('#38bdf8')
                    .atmosphereAltitude(0.15);

                scene.add(globe);

                loadingEl.style.display = 'none';
                statusEl.textContent = 'Static texture (no tiles)';
                statusEl.className = 'warn';
                log('Globe with static texture created', 'success');

                animate();
            } catch (err) {
                log('Static init error: ' + err.message, 'error');
                initFallback();
            }
        }

        function initFallback() {
            log('Using pure Three.js fallback...');
            try {
                setupScene();

                // Create simple textured sphere
                const geometry = new THREE.SphereGeometry(100, 64, 64);
                const loader = new THREE.TextureLoader();
                const texture = loader.load(
                    'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
                    () => log('Texture loaded', 'success'),
                    undefined,
                    (err) => log('Texture error: ' + err, 'error')
                );
                const material = new THREE.MeshPhongMaterial({ map: texture });
                globe = new THREE.Mesh(geometry, material);
                scene.add(globe);

                loadingEl.style.display = 'none';
                statusEl.textContent = 'Basic sphere (fallback)';
                statusEl.className = 'warn';
                log('Fallback sphere created', 'success');

                animate();
            } catch (err) {
                log('FATAL: All init methods failed: ' + err.message, 'error');
                loadingEl.innerHTML = '<div class="error">All initialization failed</div>';
            }
        }

        function setupScene() {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('globe-container').appendChild(renderer.domElement);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1628);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 0, 300);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(1, 1, 1);
            scene.add(dirLight);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            controls.minDistance = 101;
            controls.maxDistance = 500;
            controls.enablePan = false;

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            log('Scene setup complete', 'success');
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            distEl.textContent = camera.position.length().toFixed(0);
        }

        function flyTo(lat, lon, altitude = 150) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const radius = 100 + altitude;

            const x = radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.cos(phi);
            const z = radius * Math.sin(phi) * Math.sin(theta);

            const startPos = camera.position.clone();
            const endPos = new THREE.Vector3(x, y, z);
            const startTime = Date.now();

            function step() {
                const t = Math.min((Date.now() - startTime) / 2000, 1);
                const eased = 1 - Math.pow(1 - t, 3);
                camera.position.lerpVectors(startPos, endPos, eased);
                camera.lookAt(0, 0, 0);
                if (t < 1) requestAnimationFrame(step);
            }
            step();
            log(`Flying to ${lat}, ${lon}`, 'log');
        }

        function resetView() {
            camera.position.set(0, 0, 300);
            camera.lookAt(0, 0, 0);
        }
    </script>
</body>
</html>
